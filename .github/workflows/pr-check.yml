name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for breaking changes
        run: |
          echo "Checking for breaking changes in core files..."
          git diff --name-only origin/main...HEAD | grep -E "(core/executor.ts|lib/types.ts|cli.ts)" && \
            echo "⚠️  Breaking changes detected in core files" || \
            echo "✅ No breaking changes detected"

      - name: Run unit tests
        run: npm test
        env:
          CI: true

      - name: Check test coverage
        run: |
          if [ -f coverage/lcov.info ]; then
            COVERAGE=$(npx c8 report --reporter=text-summary | grep "Lines" | awk '{print $3}' | sed 's/%//')
            echo "Test coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "⚠️  Test coverage is below 80%"
            else
              echo "✅ Test coverage is acceptable"
            fi
          fi

      - name: Validate package.json
        run: |
          node -e "
            const pkg = require('./package.json');
            if (!pkg.name || !pkg.version || !pkg.description) {
              console.error('❌ package.json is missing required fields');
              process.exit(1);
            }
            console.log('✅ package.json is valid');
          "

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments in changed files..."
          TODOS=$(git diff origin/main...HEAD | grep -E "^\+.*\b(TODO|FIXME|XXX|HACK)\b" || true)
          if [ -n "$TODOS" ]; then
            echo "⚠️  Found TODO/FIXME comments:"
            echo "$TODOS"
          else
            echo "✅ No TODO/FIXME comments found"
          fi

      - name: Post PR comment with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });

            const allPassed = checks.check_runs.every(check => check.conclusion === 'success');
            const message = allPassed
              ? '✅ All checks passed! This PR is ready for review.'
              : '⚠️  Some checks failed. Please review the CI results above.';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
